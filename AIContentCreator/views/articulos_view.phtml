<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Noticias por género - AI Content Creator</title>

    <!-- Estilos generales + específicos de noticias -->
    <link rel="stylesheet" href="<?= BASE_URL ?>styles/home.css">
    <link rel="stylesheet" href="<?= BASE_URL ?>styles/noticias.css">
</head>

<body>

<header>AI CONTENT CREATOR - Noticias por género</header>

<div class="news-header-bar">
    <h1 class="page-title">
        Noticias del género: "<?= htmlspecialchars($genero['tema']) ?>"
    </h1>

    <a href="<?= BASE_URL ?>index.php?controller=home" class="btn btn-back">
        ← Volver al Home
    </a>
</div>

<p class="page-sub">
    Descripción del género: <?= htmlspecialchars($genero['descripcion']) ?>
</p>

<?php if (!empty($noticias)): ?>
    <table class="news-table">
        <thead>
        <tr>
            <th>Título</th>
            <th>Descripción</th>
            <th>Imagen</th>
            <th>Estados / Guardar</th>
        </tr>
        </thead>

        <tbody>
        <?php foreach ($noticias as $row): ?>

            <?php
            // --------------------------
            // NORMALIZACIÓN DE DATOS
            // --------------------------

            // ID noticia (si viene de n8n, puede no existir)
            $rowId = $row['id'] ?? 0;

            // id_genero seguro (desde BBDD o desde la URL)
            $rowIdGenero = $row['id_genero'] ?? ($idGenero ?? 0);

            // Fecha: BBDD > n8n(createdAt) > null
            $fechaPub = $row['fecha_publicacion']
                ?? ($row['createdAt'] ?? null);

            // Estados
            $notRev = $row['noticia_revisada'] ?? null;
            $imgRev = $row['imagen_revisada'] ?? null;
            $pubVal = $row['publicado'] ?? null;
            ?>

            <tr>

                <!-- TÍTULO -->
                <td style="max-width: 350px; white-space: normal;">
                    <strong><?= nl2br(htmlspecialchars($row['titulo'] ?? '')) ?></strong><br>
                    <small>
                        <?= !empty($fechaPub)
                            ? date("d/m/Y H:i", strtotime($fechaPub))
                            : "No publicada" ?>
                    </small>
                </td>

                <!-- DESCRIPCIÓN -->
                <td class="td-descripcion">
                    <div class="descripcion-scroll">
                        <?= nl2br(htmlspecialchars($row['descripcion'] ?? '')) ?>
                    </div>
                </td>

                <!-- IMAGEN -->
                <td class="td-imagen">
                    <?php if (!empty($row['imagen'])): ?>
                        <img src="<?= htmlspecialchars($row['imagen']) ?>" alt="Imagen noticia" class="img-ajustada">
                    <?php else: ?>
                        <em>Sin imagen</em>
                    <?php endif; ?>
                </td>

                <!-- ESTADOS + GUARDAR -->
                <td>
                    <form method="POST" action="<?= BASE_URL ?>controllers/guardar_noticia.php" class="news-form">

                        <input type="hidden" name="id" value="<?= (int)$rowId ?>">
                        <input type="hidden" name="id_genero" value="<?= (int)$rowIdGenero ?>">

                        <!-- NOTICIA -->
                        <div class="field-group">
                            <label>Noticia</label>
                            <select name="noticia_revisada" class="select-status">
                                <option value=" " <?= ($notRev === null || $notRev === '') ? 'selected' : '' ?>></option>
                                <option value="pendiente" <?= ($notRev === 'pendiente') ? 'selected' : '' ?>>Pendiente</option>
                                <option value="revisada" <?= ($notRev === 'revisada') ? 'selected' : '' ?>>Revisada</option>
                            </select>
                        </div>

                        <!-- IMAGEN -->
                        <div class="field-group">
                            <label>Imagen</label>
                            <select name="imagen_revisada" class="select-status">
                                <option value=" " <?= ($imgRev === null || $imgRev === '') ? 'selected' : '' ?>></option>
                                <option value="pendiente" <?= ($imgRev === 'pendiente') ? 'selected' : '' ?>>Pendiente</option>
                                <option value="aprobada" <?= ($imgRev === 'aprobada') ? 'selected' : '' ?>>Aprobada</option>
                            </select>
                        </div>

                        <!-- PUBLICACIÓN -->
                        <div class="field-group">
                            <label>Publicación</label>
                            <select name="publicado" class="select-status">
                                <option value=" " <?= ($pubVal === null || $pubVal === '') ? 'selected' : '' ?>></option>
                                <option value="borrador" <?= ($pubVal === 'borrador') ? 'selected' : '' ?>>Borrador</option>
                                <option value="publicado" <?= ($pubVal === 'publicado') ? 'selected' : '' ?>>Publicado</option>
                            </select>
                        </div>

                        <button type="submit" class="btn primary btn-sm" style="margin-top:8px; margin-bottom: 8px;">
                            Guardar
                        </button>
                    </form>
                </td>

            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>

<?php else: ?>
    <p>No hay noticias creadas todavía para este género.</p>
<?php endif; ?>

</body>

</html>
